<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Market - Home</title>
    <style>
        /* --- 1. CSS Variables & Reset --- */
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --dark: #343a40;
            --light: #f8f9fa;
            --text-main: #333;
            --text-muted: #666;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a { text-decoration: none; color: inherit; }

        /* --- 2. Navigation Bar --- */
        nav {
            background-color: white;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-auth {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn-login { color: var(--text-main); border: 1px solid #ddd; }
        .btn-login:hover { background-color: var(--light); }
        .btn-signup { background-color: var(--success); color: white; border: none; }
        .btn-signup:hover { background-color: #218838; }

        /* --- 3. Profile Dropdown --- */
        .profile-container { position: relative; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        .profile-img {
            width: 40px; height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid #eee;
            z-index: 1000;
        }
        .dropdown-menu.show { display: block; animation: fadeIn 0.2s; }
        
        .dropdown-menu a {
            padding: 12px 15px;
            display: flex; align-items: center; gap: 10px;
            font-size: 0.95rem; color: var(--text-main);
            transition: background 0.2s;
        }
        .dropdown-menu a:hover { background-color: #f8f9fa; color: var(--primary); }

        /* --- 4. Hero Section --- */
        .hero {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 40px;
        }

        .hero h1 { margin: 0 0 10px; font-size: 2.5rem; }
        .hero p { opacity: 0.9; font-size: 1.1rem; margin-bottom: 30px; }

        .search-container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            background: white;
            border-radius: 30px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .search-input {
            flex: 1; border: none; padding: 12px 20px;
            font-size: 1rem; outline: none; border-radius: 30px;
        }
        
        .search-btn {
            background-color: var(--primary); color: white; border: none;
            padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer;
            transition: background 0.2s;
        }
        .search-btn:hover { background-color: var(--primary-dark); }

        /* --- 5. Main Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px 20px; }

        .ads-banner {
            background-color: #fff3cd; color: #856404;
            padding: 15px; border-radius: var(--border-radius);
            margin-bottom: 30px; border: 1px solid #ffeeba;
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px;
        }
        .section-title { font-size: 1.5rem; color: var(--dark); margin: 0; }

        /* --- 6. Product Grid --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 25px;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); }

        .product-image {
            width: 100%; height: 180px;
            object-fit: cover; background-color: #eee;
        }

        .product-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        
        .product-title {
            font-size: 1.05rem; margin: 0 0 5px;
            font-weight: 600; color: var(--dark);
        }
        
        .product-desc {
            font-size: 0.85rem; color: var(--text-muted);
            margin-bottom: 15px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .product-footer {
            margin-top: auto;
            display: flex; justify-content: space-between; align-items: center;
        }

        .price { font-size: 1.2rem; font-weight: bold; color: var(--success); }

        .btn-view {
            background-color: var(--primary); color: white;
            padding: 8px 15px; border-radius: 5px; font-size: 0.9rem;
        }
        .btn-view:hover { background-color: var(--primary-dark); }

        /* --- 7. Quick Wishcart (Moved Outside Loop) --- */
        .wishcart-section { margin-top: 50px; }
        .wishcart-item {
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 10px; border-bottom: 1px solid #eee;
        }
        .wishcart-item:last-child { border-bottom: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 600px) {
            .hero h1 { font-size: 1.8rem; }
            .nav-actions span { display: none; } /* Hide "Hi, Name" on mobile */
            .product-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .product-image { height: 140px; }
        }
    </style>
</head>
<body>

    <nav>
        <a href="/" class="nav-brand">UI Market</a>
        
        <div class="nav-actions">
            <% if (typeof user !== 'undefined' && user) { %>
                <span style="color: #666; font-size: 0.9rem;">Hi, <%= user.username %></span>

                <div class="profile-container" onclick="toggleProfileMenu(event)">
                    <img src="<%= user.profile_image ? '/uploads/' + user.profile_image : 'https://ui-avatars.com/api/?name=' + user.username + '&background=007bff&color=fff' %>" class="profile-img">
                    
                    <div id="profileDropdown" class="dropdown-menu">
                        <div style="padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--dark);">
                            <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %> Account
                        </div>

                        <% if (user.role === 'seller') { %>
                            <a href="/seller/dashboard"><span>üìä</span> Seller Dashboard</a>
                        <% } else if (user.role === 'buyer') { %>
                            <a href="/buyer/dashboard"><span>üõç</span> Buyer Dashboard</a>
                        <% } else if (user.role === 'admin') { %>
                            <a href="/admin_dashboard"><span>üõ°</span> Admin Panel</a>
                        <% } %>

                        <a href="/settings"><span>‚öô</span> Settings</a>
                        <div style="height: 1px; background: #eee; margin: 0;"></div>
                        <a href="/logout" style="color: var(--danger);"><span>üö™</span> Logout</a>
                    </div>
                </div>

            <% } else { %>
                <a href="/login" class="btn-auth btn-login">Login</a>
                <a href="/signup" class="btn-auth btn-signup">Sign Up</a>
            <% } %>
        </div>
    </nav>

    <header class="hero">
        <h1>University of Ibadan Market</h1>
        <p>The safest way to buy and sell items on campus.</p>

        <div class="search-container">
            <form action="/" method="GET" style="width: 100%; display: flex;">
                <input type="text" name="search" class="search-input" placeholder="What are you looking for? (e.g. MTH 101, iPhone 12)" value="<%= typeof searchTerm !== 'undefined' ? searchTerm : '' %>">
                <button type="submit" class="search-btn">Search</button>
            </form>
        </div>
        <% if (typeof searchTerm !== 'undefined' && searchTerm) { %>
            <div style="margin-top: 10px;">
                <a href="/" style="color: rgba(255,255,255,0.8); text-decoration: underline;">Clear Search</a>
            </div>
        <% } %>
    </header>

    <div class="container">
        
        <% if (typeof ads !== 'undefined' && ads && ads.length > 0) { %>
            <div class="ads-banner">
                <h3 style="margin-top: 0; font-size: 1.1rem;">üì¢ Campus Updates</h3>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <% ads.forEach(function(ad) { %>
                        <li><%= ad.message %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>

        <div class="section-header">
            <h2 class="section-title">Latest Products</h2>
        </div>
        
        <div class="product-grid">
            <% if (typeof products !== 'undefined' && products.length > 0) { %>
                <% products.forEach(function(product) { %>
                    <div class="product-card">
                        <img 
                            src="<%= product.image && !product.image.startsWith('http') ? '/uploads/' + product.image : (product.image || 'https://via.placeholder.com/300x200?text=No+Image') %>" 
                            alt="<%= product.name %>" 
                            class="product-image"
                        >
                        
                        <div class="product-info">
                            <h3 class="product-title"><%= product.name || product.title %></h3>
                            <p class="product-desc"><%= product.description || 'No description available.' %></p>
                            
                            <div class="product-footer">
                                <span class="price">‚Ç¶<%= parseInt(product.price).toLocaleString() %></span>
                                <a href="/buy/<%= product.id %>" class="btn-view">View</a>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                    <h3>No products found.</h3>
                    <p>Check back later or try a different search term.</p>
                </div>
            <% } %>
        </div>

        <% if (typeof user !== 'undefined' && user && typeof cartItems !== 'undefined' && cartItems.length > 0) { %>
            <div class="wishcart-section">
                <div class="section-header">
                    <h2 class="section-title">Your Wishcart (<%= cartItems.length %>)</h2>
                    <a href="/buyer/dashboard" style="color: var(--primary); font-weight: bold;">Manage Cart &rarr;</a>
                </div>
                
                <div style="background: white; border-radius: 8px; box-shadow: var(--shadow); overflow: hidden;">
                    <% cartItems.slice(0, 3).forEach(function(item) { %>
                        <div class="wishcart-item">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="<%= item.image_url || 'https://via.placeholder.com/50' %>" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                <div>
                                    <div style="font-weight: bold;"><%= item.title || item.name %></div>
                                    <div style="color: var(--success);">‚Ç¶<%= item.price.toLocaleString() %></div>
                                </div>
                            </div>
                            <a href="/buy/<%= item.id %>" style="font-size: 0.85rem; color: white; background: var(--primary); padding: 5px 10px; border-radius: 4px;">Buy Now</a>
                        </div>
                    <% }); %>
                    <% if(cartItems.length > 3) { %>
                        <div style="padding: 10px; text-align: center; background: #f8f9fa;">
                            <a href="/buyer/dashboard" style="color: var(--text-muted); font-size: 0.9rem;">View all items...</a>
                        </div>
                    <% } %>
                </div>
            </div>
        <% } %>

    </div>

    <script>
        function toggleProfileMenu(event) {
            event.stopPropagation();
            document.getElementById("profileDropdown").classList.toggle("show");
        }

        window.onclick = function(event) {
            if (!event.target.closest('.profile-container')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) {
                        dropdowns[i].classList.remove('show');
                    }
                }
            }
        }
    </script>
</body>
</html>