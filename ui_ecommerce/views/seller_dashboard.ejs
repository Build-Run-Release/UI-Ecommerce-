<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - UI Market</title>
    <!-- Link to Modern CSS -->
    <link rel="stylesheet" href="/css/modern.css">
</head>

<body>

    <div class="overlay" id="mainOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="brand">
            <span>Seller Center</span>
            <button class="close-sidebar" id="closeSidebarBtn">√ó</button>
        </div>

        <div class="nav-links">
            <a href="/seller/dashboard" class="active">Dashboard</a>
            <a href="#" id="navAddProductBtn">Ôºã List New Item</a>
            <a href="#orders">Incoming Orders</a>
            <a href="#inventory">My Inventory</a>
            <a href="/settings">Settings</a>
            <a href="/">Go to Shop</a>
            <a href="/feedback">Feedback/Report</a>
            <div style="margin-top: auto;">
                <a href="/logout" style="color: #ef4444;">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggleBtn">‚ò∞</button>
                <h1 style="margin: 0; font-size: 1.5rem;">Dashboard</h1>
            </div>

            <div class="header-actions" style="display: flex; align-items: center; gap: 20px;">
                <button type="button" class="btn btn-primary" id="headerAddProductBtn">
                    <span>Ôºã</span> <span style="display: none; @media(min-width: 600px){ display: inline; }">List
                        Item</span>
                </button>

                <div style="text-align: right;">
                    <small style="color: var(--text-muted);">Earnings</small><br>
                    <strong style="color: var(--success-color);">‚Ç¶<%= (user.wallet_balance || 0).toLocaleString() %>
                    </strong>
                </div>

                <div class="profile-actions">
                    <img src="<%= user.profile_image && !user.profile_image.startsWith('http') ? '/uploads/' + user.profile_image : (user.profile_image || 'https://ui-avatars.com/api/?name=' + user.username + '&background=4f46e5&color=fff') %>"
                        class="profile-img" id="profileImgTrigger">
                    <!-- Simple absolute upload trigger for profile pic if needed, hidden for clean look -->

                    <div id="profileDropdown" class="dropdown-menu">
                        <div class="dropdown-header">
                            <small>Signed in as</small><br>
                            <strong>
                                <%= user.username %>
                            </strong>
                        </div>
                        <a href="/">üè† Go to Shop</a>
                        <a href="/ads/buy">üì¢ Promote Items</a>
                        <a href="#settings">‚öô Settings</a>
                        <a href="/logout" style="color: var(--danger-color);">üö™ Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Stats -->
        <div class="stats-grid">
            <div class="card stat-card">
                <span class="stat-label">Total Earnings</span>
                <span class="stat-value">‚Ç¶<%= (user.wallet_balance || 0).toLocaleString() %></span>
            </div>
            <div class="card stat-card">
                <span class="stat-label">Active Listings</span>
                <span class="stat-value">
                    <%= products ? products.length : 0 %>
                </span>
            </div>
            <div class="card stat-card">
                <span class="stat-label">Pending Orders</span>
                <% let pendingCount=0; if(orders){ orders.forEach(o=> { if(!o.seller_confirmed) pendingCount++; }); } %>
                    <span class="stat-value" style="color: var(--warning-color);">
                        <%= pendingCount %>
                    </span>
            </div>
        </div>

        <!-- Content Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">

            <!-- Orders Card -->
            <div id="orders" class="card" style="grid-column: 1 / -1;">
                <h2>Incoming Orders</h2>
                <div class="table-responsive">
                    <% if (orders && orders.length> 0) { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Item</th>
                                    <th>Earnings</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach(function(order) { %>
                                    <tr>
                                        <td>#<%= order.id %>
                                        </td>
                                        <td>Item #<%= order.product_id %>
                                        </td>
                                        <td>‚Ç¶<%= order.seller_amount %>
                                        </td>
                                        <td>
                                            <% if (order.buyer_confirmed) { %>
                                                <span class="badge badge-success">Completed</span>
                                                <% } else if (order.seller_confirmed) { %>
                                                    <span class="badge badge-blue">Shipped</span>
                                                    <% } else { %>
                                                        <span class="badge badge-warning">Pending</span>
                                                        <% } %>
                                        </td>
                                        <td>
                                        <td>
                                            <% if (order.buyer_confirmed || order.escrow_released) { %>
                                                <span class="badge badge-success">Completed</span>
                                                <% } else { %>
                                                    <div style="display: flex; flex-direction: column; gap: 5px;">

                                                        <% if (!order.seller_confirmed) { %>
                                                            <!-- Step 1: Mark Delivered -->
                                                            <form
                                                                action="/order/<%= order.id %>/confirm/seller-delivered"
                                                                method="POST">
                                                                <input type="hidden" name="_csrf"
                                                                    value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                                <button type="submit" class="btn btn-primary btn-sm"
                                                                    style="width: 100%;">I have Delivered</button>
                                                            </form>
                                                            <% } else { %>
                                                                <!-- Step 2: Enter Code OR Wait -->
                                                                <div
                                                                    style="font-size: 0.8rem; color: var(--success-color); margin-bottom: 2px;">
                                                                    Item Delivered</div>

                                                                <form
                                                                    action="/order/<%= order.id %>/confirm/seller-code"
                                                                    method="POST" style="display: flex; gap: 5px;">
                                                                    <input type="hidden" name="_csrf"
                                                                        value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                                    <input type="text" name="delivery_code"
                                                                        placeholder="Buyer Code"
                                                                        style="width: 80px; padding: 4px; font-size: 0.8rem;"
                                                                        required>
                                                                    <button type="submit"
                                                                        class="btn btn-success btn-sm">Verify</button>
                                                                </form>

                                                                <!-- Fallbacks -->
                                                                <div style="display: flex; gap: 5px; margin-top: 5px;">
                                                                    <!-- Claim Funds (Auto Release) -->
                                                                    <form action="/order/<%= order.id %>/claim-funds"
                                                                        method="POST">
                                                                        <input type="hidden" name="_csrf"
                                                                            value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                                        <button type="submit"
                                                                            class="btn btn-outline btn-sm"
                                                                            title="Available 24h after delivery">Claim
                                                                            Funds</button>
                                                                    </form>

                                                                    <!-- Dispute -->
                                                                    <% if (!order.disputed) { %>
                                                                        action="/order/<%= order.id %>/dispute"
                                                                            method="POST"
                                                                            data-confirm="Report a problem with this
                                                                            order?">
                                                                            <input type="hidden" name="_csrf"
                                                                                value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                                            <button type="submit"
                                                                                class="btn btn-danger btn-sm">Report</button>
                                                                            </form>
                                                                            <% } else { %>
                                                                                <span
                                                                                    class="badge badge-warning">Disputed</span>
                                                                                <% } %>
                                                                </div>
                                                                <% } %>
                                                    </div>
                                                    <% } %>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                        <% } else { %>
                            <p style="color: var(--text-muted); padding: 10px;">No active orders.</p>
                            <% } %>
                </div>
            </div>

            <!-- Inventory Card -->
            <div id="inventory" class="card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;">
                    <h2 style="border: none; margin: 0; padding: 0;">Inventory</h2>
                    <button class="btn btn-outline btn-sm" id="inventoryAddProductBtn">+ Add</button>
                </div>

                <div class="table-responsive">
                    <% if (products && products.length> 0) { %>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% products.forEach(function(product) { %>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <img src="<%= product.image_url && !product.image_url.startsWith('http') ? '/uploads/' + product.image_url : (product.image_url || '/images/placeholder.svg') %>"
                                                    width="40" height="40"
                                                    style="border-radius: 6px; object-fit: cover;">
                                                <div style="font-weight: 500;">
                                                    <%= product.title %>
                                                </div>
                                            </div>
                                        </td>
                                        <td>‚Ç¶<%= product.price %>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="btn btn-outline btn-sm edit-product-btn"
                                                    data-id="<%= product.id %>" data-title="<%= product.title %>"
                                                    data-price="<%= product.price %>"
                                                    data-desc="<%= product.description %>"
                                                    data-cat="<%= product.category %>">
                                                    ‚úé
                                                </button>
                                                <form action="/seller/product/<%= product.id %>/delete" method="POST"
                                                    data-confirm="Delete this item?">
                                                    <input type="hidden" name="_csrf"
                                                        value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                    <button type="submit" class="btn btn-danger btn-sm">√ó</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                        <% } else { %>
                            <p style="color: var(--text-muted);">No products listed yet.</p>
                            <% } %>
                </div>
            </div>

            <!-- Settings Card -->
            <div id="settings" class="card">
                <h2>Payout Details</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: -10px;">Where should we send your
                    money?</p>
                <form action="/seller/onboard" method="POST">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                    <label for="bank_name">Bank Name</label>
                    <input type="text" id="bank_name" name="bank_name" value="<%= user.bank_name || '' %>"
                        placeholder="e.g. GTBank" required>

                    <label for="account_number">Account Number</label>
                    <input type="text" id="account_number" name="account_number"
                        value="<%= user.account_number || '' %>" placeholder="0123456789" required>

                    <label for="bank_code">Bank Code</label>
                    <input type="text" id="bank_code" name="bank_code" value="<%= user.bank_code || '' %>"
                        placeholder="058" required>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Details</button>
                </form>
            </div>

        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeAddProductModalBtn">&times;</span>
            <h2>List New Product</h2>

            <form action="/seller/add-product" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                <label for="prodTitle">Product Title</label>
                <input type="text" id="prodTitle" name="title" required placeholder="e.g. iPhone 12">

                <label for="prodPrice">Price (‚Ç¶)</label>
                <input type="number" id="prodPrice" name="price" required placeholder="150000">

                <label for="prodDesc">Description</label>
                <textarea id="prodDesc" name="description" rows="3" required
                    placeholder="Condition, color, defects..."></textarea>

                <label for="prodCat">Category</label>
                <select id="prodCat" name="category" required>
                    <option value="" disabled selected>Select Category</option>
                    <% if (typeof categories !=='undefined' ) { %>
                        <% categories.forEach(function(cat) { %>
                            <option value="<%= cat %>">
                                <%= cat %>
                            </option>
                            <% }); %>
                                <% } else { %>
                                    <option value="Other">Other</option>
                                    <% } %>
                </select>

                <label for="prodImg">Product Image</label>
                <div class="file-upload-box" id="fileUploadBox">
                    <span style="font-size: 2rem;">‚òÅ</span><br>
                    <span>Click to Upload</span>
                    <input type="file" name="image" id="prodImg" accept="image/*" style="display: none;">
                </div>

                <div id="previewContainer" style="display: none; text-align: center; margin-top: 15px;">
                    <img id="imgPreview" src=""
                        style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Publish Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditProductModalBtn">&times;</span>
            <h2>Edit Product</h2>

            <form id="editForm" action="" method="POST">
                <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                <label for="editTitle">Product Title</label>
                <input type="text" id="editTitle" name="title" required>

                <label for="editPrice">Price (‚Ç¶)</label>
                <input type="number" id="editPrice" name="price" required>

                <label for="editDesc">Description</label>
                <textarea id="editDesc" name="description" rows="3" required></textarea>

                <label for="editCategory">Category</label>
                <select id="editCategory" name="category" required>
                    <% if (typeof categories !=='undefined' ) { %>
                        <% categories.forEach(function(cat) { %>
                            <option value="<%= cat %>">
                                <%= cat %>
                            </option>
                            <% }); %>
                                <% } else { %>
                                    <option value="Other">Other</option>
                                    <% } %>
                </select>

                <p style="font-size: 0.8rem; color: var(--text-muted);">* Image update not supported in quick edit.</p>

                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/seller_dashboard.js"></script>
</body>

</html>