<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard | Campus Market</title>
    <link rel="stylesheet" href="/css/campus-theme.css">
    <style>
        /* Specific Dashboard Styles */
        .dash-nav {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .dash-tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .dash-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
    </style>
</head>

<body style="background: var(--bg-body);">

    <!-- Navbar -->
    <nav class="navbar-rewrite">
        <div class="container flex justify-between items-center">
            <a href="/" class="font-bold text-primary">CampusMarket</a>
            <div class="flex gap-2">
                <a href="/" class="btn btn-outline text-sm">Shop</a>
                <a href="/logout" class="btn btn-outline text-sm"
                    style="border-color: var(--danger); color: var(--danger);">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 2rem; padding-bottom: 4rem;">

        <!-- Header -->
        <div class="flex justify-between items-end" style="margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 1.5rem;">Seller Dashboard</h1>
                <p class="text-muted">Welcome back, <strong>
                        <%= user.username %>
                    </strong></p>
            </div>
            <button id="openAddModalBtn" class="btn btn-primary">+ List Item</button>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 md:grid-cols-4" style="gap: 1rem; margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-value">₦<%= (user.wallet_balance || 0).toLocaleString() %>
                </div>
                <div class="stat-label">Wallet</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">
                    <%= products ? products.length : 0 %>
                </div>
                <div class="stat-label">Active Items</div>
            </div>
            <div class="stat-card">
                <% let pendingCount=0; if(orders){ orders.forEach(o=> { if(!o.seller_confirmed) pendingCount++; }); } %>
                    <div class="stat-value <%= pendingCount > 0 ? 'text-accent' : '' %>">
                        <%= pendingCount %>
                    </div>
                    <div class="stat-label">Pending Orders</div>
            </div>
        </div>

        <!-- Dashboard Tabs -->
        <div class="dash-nav">
            <div class="dash-tab active" onclick="switchTab('orders')">Orders & Sales</div>
            <div class="dash-tab" onclick="switchTab('inventory')">My Inventory</div>
            <div class="dash-tab" onclick="switchTab('payouts')">Payouts & Settings</div>
        </div>

        <!-- TAB: ORDERS -->
        <div id="tab-orders" class="tab-content active">
            <% if (orders && orders.length> 0) { %>
                <div class="grid gap-4">
                    <% orders.forEach(function(order) { %>
                        <div class="card flex flex-col md:flex-row gap-4 justify-between">
                            <div class="flex gap-4">
                                <img src="<%= order.image_url && !order.image_url.startsWith('http') ? '/uploads/' + order.image_url : (order.image_url || '/images/placeholder.svg') %>"
                                    style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #eee;">
                                <div>
                                    <div class="font-bold">Order #<%= order.id %>
                                    </div>
                                    <div class="text-sm">
                                        <%= order.product_title %>
                                    </div>
                                    <div class="text-primary font-bold">Earn: ₦<%= order.seller_amount.toLocaleString()
                                            %>
                                    </div>
                                    <div class="text-xs text-muted">
                                        <%= new Date(order.created_at).toLocaleDateString() %>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2" style="min-width: 200px;">
                                <% if (order.buyer_confirmed) { %>
                                    <div class="badge badge-new"
                                        style="background: #dcfce7; color: #166534; text-align: center;">Completed</div>
                                    <% } else if (order.seller_confirmed) { %>
                                        <div class="badge"
                                            style="background: #e0f2fe; color: #075985; text-align: center;">Shipped /
                                            Delivered</div>

                                        <!-- CODE VERIFICATION -->
                                        <form action="/order/<%= order.id %>/confirm/seller-code" method="POST"
                                            class="flex gap-2">
                                            <input type="hidden" name="_csrf"
                                                value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                            <input type="text" name="delivery_code" placeholder="Buyer Code"
                                                class="input-base" style="padding: 0.4rem; font-size: 0.8rem;" required>
                                            <button class="btn btn-secondary"
                                                style="padding: 0.4rem 1rem; font-size: 0.8rem;">Verify</button>
                                        </form>

                                        <% } else { %>
                                            <form action="/order/<%= order.id %>/confirm/seller-delivered"
                                                method="POST">
                                                <input type="hidden" name="_csrf"
                                                    value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                                <button class="btn btn-primary" style="width: 100%;">Mark
                                                    Delivered</button>
                                            </form>
                                            <% } %>
                            </div>
                        </div>
                        <% }); %>
                </div>
                <% } else { %>
                    <div class="text-center text-muted" style="padding: 2rem;">No orders yet.</div>
                    <% } %>
        </div>

        <!-- TAB: INVENTORY -->
        <div id="tab-inventory" class="tab-content">
            <div class="grid md:grid-cols-2 gap-4">
                <% if (products && products.length> 0) { %>
                    <% products.forEach(function(p) { %>
                        <div class="card flex gap-4 items-center">
                            <img src="<%= p.image_url && !p.image_url.startsWith('http') ? '/uploads/' + p.image_url : (p.image_url || '/images/placeholder.svg') %>"
                                style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
                            <div style="flex: 1;">
                                <div class="font-bold truncate">
                                    <%= p.title %>
                                </div>
                                <div class="text-xs text-muted">₦<%= parseInt(p.price).toLocaleString() %> • <%=
                                            p.category %>
                                </div>
                            </div>
                            <!-- Actions -->
                            <form action="/seller/product/<%= p.id %>/delete" method="POST"
                                onsubmit="return confirm('Delete item?');">
                                <input type="hidden" name="_csrf"
                                    value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                                <button class="btn btn-outline text-xs"
                                    style="color: var(--danger); border-color: var(--danger);">Del</button>
                            </form>
                        </div>
                        <% }); %>
                            <% } else { %>
                                <div class="text-muted">No items list. Click "+ List Item" to start.</div>
                                <% } %>
            </div>
        </div>

        <!-- TAB: PAYOUTS -->
        <div id="tab-payouts" class="tab-content">
            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h3>Bank Details</h3>
                <form action="/seller/onboard" method="POST" class="flex flex-col gap-4" style="margin-top: 1rem;">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                    <div>
                        <label class="text-sm font-bold">Bank Name</label>
                        <input type="text" name="bank_name" value="<%= user.bank_name || '' %>" class="input-base"
                            placeholder="e.g. GTBank" required>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Account Number</label>
                        <input type="text" name="account_number" value="<%= user.account_number || '' %>"
                            class="input-base" placeholder="0123456789" required>
                    </div>
                    <div>
                        <label class="text-sm font-bold">Bank Code</label>
                        <input type="text" name="bank_code" value="<%= user.bank_code || '' %>" class="input-base"
                            placeholder="058" required>
                    </div>
                    <button class="btn btn-primary">Update Details</button>
                </form>

                <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

                <h3>Withdraw Funds</h3>
                <form action="/seller/withdraw" method="POST" class="flex gap-2" style="margin-top: 1rem;">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                    <input type="number" name="amount" class="input-base" placeholder="Amount (min 100)" min="100"
                        required>
                    <button class="btn btn-secondary">Withdraw</button>
                </form>
            </div>
        </div>

    </div>

    <!-- Add Product Modal -->
    <div id="addModal" class="modal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100;">
        <div class="card" style="width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative;">
            <button onclick="document.getElementById('addModal').style.display='none'"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem;">&times;</button>
            <h2>List New Item</h2>
            <form action="/seller/add-product" method="POST" enctype="multipart/form-data" class="flex flex-col gap-4"
                style="margin-top: 1rem;">
                <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                <input type="text" name="title" placeholder="Title (e.g. Chem 101 Textbook)" class="input-base"
                    required>
                <input type="number" name="price" placeholder="Price (₦)" class="input-base" required>

                <select name="category" class="input-base" required>
                    <option value="">Select Category</option>
                    <% if (typeof categories !=='undefined' ) { %>
                        <% categories.forEach(function(cat) { %>
                            <option value="<%= cat %>">
                                <%= cat %>
                            </option>
                            <% }); %>
                                <% } %>
                </select>

                <div class="grid grid-cols-2 gap-4">
                    <select name="condition" class="input-base">
                        <option value="New">Condition: New</option>
                        <option value="Like New">Like New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                    </select>
                    <input type="text" name="campus_zone" placeholder="Zone (e.g. North Campus)" class="input-base">
                </div>

                <textarea name="description" rows="3" placeholder="Description..." class="input-base"
                    required></textarea>

                <label class="btn btn-outline" style="text-align: center; cursor: pointer;">
                    Upload Image
                    <input type="file" name="image" accept="image/*" style="display: none;">
                </label>

                <button class="btn btn-primary">Post Item</button>
            </form>
        </div>
    </div>

    <script>
        function switchTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.dash-tab').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById('tab-' + tabId).classList.add('active');
            // Active state
            event.target.classList.add('active');
        }

        document.getElementById('openAddModalBtn').onclick = () => document.getElementById('addModal').style.display = 'flex';
    </script>
</body>

</html>